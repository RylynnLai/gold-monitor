# 飞书 Webhook 配置指南

## 为什么使用 Webhook？

飞书 Webhook 比传统的飞书开放平台应用更简单：

**传统方式**（已废弃）：
- ❌ 需要创建飞书应用
- ❌ 需要配置 App ID 和 App Secret
- ❌ 需要获取 Chat ID
- ❌ 需要管理 access_token

**Webhook 方式**（当前）：
- ✅ 只需一个 Webhook URL
- ✅ 无需创建应用
- ✅ 配置简单，5分钟搞定

## 获取飞书 Webhook URL

### 步骤1：进入群聊设置

1. 打开需要接收通知的飞书群聊
2. 点击右上角的「...」或「设置」按钮
3. 选择「群机器人」选项

### 步骤2：添加自定义机器人

4. 点击「添加机器人」
5. 在机器人列表中选择「自定义机器人」
6. 点击「添加」

### 步骤3：配置机器人

7. 设置机器人信息：
   - **名称**：黄金价格监控
   - **描述**（可选）：自动监控黄金价格变化并发送通知
   - **头像**（可选）：上传自定义图片

8. 安全设置（可选但推荐）：
   - **签名校验**：暂不启用（如需安全性可启用）
   - **IP 白名单**：根据需要配置

### 步骤4：获取 Webhook URL

9. 配置完成后，系统会生成 Webhook 地址
10. 复制 Webhook URL，格式如：
   ```
   https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   ```

11. 点击「完成」保存配置

## 配置到项目

### 方式1：使用 .env 文件（本地开发）

1. 复制示例配置文件：
   ```bash
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，填入 Webhook URL：
   ```bash
   # 飞书 Webhook 配置
   FEISHU_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-token

   # 其他配置...
   TREND_COUNT=3
   LOG_LEVEL=INFO
   ```

3. 保存文件

### 方式2：青龙面板配置

1. 登录青龙面板
2. 进入「环境变量」页面
3. 点击「新建变量」
4. 填写变量信息：
   - **名称**：`FEISHU_WEBHOOK_URL`
   - **值**：粘贴你的 Webhook URL
   - **备注**（可选）：黄金监控飞书通知

5. 点击「保存」

## 测试 Webhook

### 使用测试命令

运行测试命令验证 Webhook 配置是否正确：

```bash
python3 src/feishu_notifier.py
```

如果配置正确，你会在飞书群聊中收到测试消息：
```
黄金价格监控系统测试消息
发送时间: 2024-01-15 10:30:25
```

### 常见错误

**错误1：请先配置 FEISHU_WEBHOOK_URL 环境变量**
- 原因：未配置 Webhook URL
- 解决：按上述步骤配置环境变量

**错误2：发送 Webhook 异常: HTTPError**
- 原因：Webhook URL 无效或已过期
- 解决：重新生成 Webhook URL

**错误3：发送 Webhook 失败: {"code": 19021}**
- 原因：机器人被移除或群聊已解散
- 解决：重新添加机器人

## 消息示例

成功配置后，当检测到价格趋势时，会收到类似的卡片消息：

```
📈 黄金价格上涨预警

当前价格         起始价格
501.85 元/克     500.50 元/克

变化幅度         趋势次数
+0.27%          连续 3 次上涨

价格序列
500.50 → 501.20 → 501.85

通知时间
2024-01-15 10:30:25

黄金价格监控系统 | 数据来源：东方财富
```

## 安全建议

1. **不要公开分享** Webhook URL，任何人获得此 URL 都可以向该群发送消息
2. **定期更换** Webhook URL，特别是怀疑泄露时
3. **启用签名校验**（高级）：在飞书机器人设置中启用，并在代码中验证签名
4. **配置 IP 白名单**：限制只有特定 IP 可以调用 Webhook

## 更换 Webhook URL

如果需要更换 Webhook URL：

1. 在飞书群聊中打开「群机器人」设置
2. 找到「黄金价格监控」机器人
3. 点击「移除」删除旧机器人
4. 按上述步骤重新添加新机器人
5. 获取新的 Webhook URL
6. 更新 `.env` 文件或青龙面板环境变量

## 禁用通知

如果暂时不想接收通知，有两种方式：

### 方式1：移除环境变量
删除或注释 `FEISHU_WEBHOOK_URL` 配置，系统会自动跳过通知

### 方式2：移除机器人
在飞书群聊中直接移除机器人即可

## 常见问题

**Q: 可以同时发送到多个群吗？**
A: 可以配置多个 Webhook URL，需要修改代码支持多 URL 配置。

**Q: Webhook URL 会过期吗？**
A: 通常不会过期，除非手动移除机器人或群聊解散。

**Q: 可以自定义消息格式吗？**
A: 可以，修改 `src/feishu_notifier.py` 中的 `send_trend_notification()` 方法。

**Q: 支持其他平台的 Webhook 吗？**
A: 目前仅支持飞书，如需企业微信或钉钉，可以参考代码自行扩展。
